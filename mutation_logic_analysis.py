# å˜å¼‚é€»è¾‘åˆ†æå·¥å…·
import random
import matplotlib.pyplot as plt
import numpy as np
from collections import defaultdict, Counter

def analyze_current_mutation_logic():
    """åˆ†æå½“å‰å˜å¼‚é€»è¾‘çš„ç‰¹ç‚¹"""
    print("=" * 60)
    print("ğŸ” å½“å‰å˜å¼‚é€»è¾‘åˆ†æ")
    print("=" * 60)
    
    print("\nğŸ“‹ å˜å¼‚ç­–ç•¥æ¦‚è§ˆ:")
    print("1. ğŸš— è½¦å¤´æ—¶è·å˜å¼‚ (ç‹¬ç«‹è¿›è¡Œ)")
    print("   - ç­–ç•¥: å±€éƒ¨å˜å¼‚ Â±3")
    print("   - çº¦æŸ: [min_headway, max_headway]")
    print("   - é¢‘ç‡: æ¯ä¸ªè½¦è¾†æŒ‰ mutpb æ¦‚ç‡å˜å¼‚")
    
    print("\n2. ğŸ² é€‰æ‹©æ€§æ¨¡å—å˜å¼‚ (äºŒé€‰ä¸€)")
    print("   - åˆå§‹é…ç½®å˜å¼‚ (50%æ¦‚ç‡)")
    print("     * éšæœºé€‰æ‹©ä¸€ä¸ªè½¦è¾†")
    print("     * å®Œå…¨é‡æ–°ç”Ÿæˆæ¨¡å—é…ç½®")
    print("     * éœ€è¦é‡æ–°ç”Ÿæˆ module_adjustments")
    print("   - æ¨¡å—è°ƒæ•´å˜å¼‚ (50%æ¦‚ç‡)")
    print("     * éšæœºé€‰æ‹©ä¸€ä¸ªè½¦è¾†ä¸€ä¸ªç«™ç‚¹")
    print("     * åŸºäº adjustment_ranges çº¦æŸå˜å¼‚")
    print("     * ç›´æ¥ä¿®æ”¹ delta_p å’Œ delta_f")

def simulate_mutation_behavior(num_simulations=1000):
    """æ¨¡æ‹Ÿå˜å¼‚è¡Œä¸ºç»Ÿè®¡"""
    print("\n" + "=" * 60)
    print("ğŸ“Š å˜å¼‚è¡Œä¸ºç»Ÿè®¡åˆ†æ")
    print("=" * 60)
    
    # æ¨¡æ‹Ÿå‚æ•°
    mutpb = 0.3  # å˜å¼‚æ¦‚ç‡
    num_vehicles = 5
    min_headway, max_headway = 3, 20
    
    # ç»Ÿè®¡æ•°æ®
    headway_changes = []
    mutation_types = []
    headway_mutation_count = 0
    
    for _ in range(num_simulations):
        # 1. è½¦å¤´æ—¶è·å˜å¼‚ç»Ÿè®¡
        headway_mutations = 0
        for vehicle_id in range(num_vehicles * 2):  # up + down
            if random.random() < mutpb:
                current_headway = random.randint(min_headway, max_headway)
                adjustment = random.randint(-3, 3)
                new_headway = max(min_headway, min(max_headway, current_headway + adjustment))
                headway_changes.append(abs(new_headway - current_headway))
                headway_mutations += 1
        
        headway_mutation_count += headway_mutations
        
        # 2. æ¨¡å—å˜å¼‚ç±»å‹ç»Ÿè®¡
        mutate_type = random.randint(0, 1)
        mutation_types.append("åˆå§‹é…ç½®" if mutate_type == 0 else "æ¨¡å—è°ƒæ•´")
    
    # åˆ†æç»“æœ
    print(f"\nğŸ“ˆ è½¦å¤´æ—¶è·å˜å¼‚ç»Ÿè®¡ (åŸºäº {num_simulations} æ¬¡æ¨¡æ‹Ÿ):")
    print(f"   å¹³å‡æ¯æ¬¡å˜å¼‚å½±å“è½¦è¾†æ•°: {headway_mutation_count / num_simulations:.2f}")
    print(f"   å¹³å‡å˜åŒ–å¹…åº¦: {np.mean(headway_changes):.2f}")
    print(f"   å˜åŒ–èŒƒå›´: {min(headway_changes)} - {max(headway_changes)}")
    
    print(f"\nğŸ¯ æ¨¡å—å˜å¼‚ç±»å‹åˆ†å¸ƒ:")
    type_counts = Counter(mutation_types)
    for mut_type, count in type_counts.items():
        print(f"   {mut_type}: {count}/{num_simulations} ({count/num_simulations*100:.1f}%)")

def analyze_mutation_effectiveness():
    """åˆ†æå˜å¼‚æœ‰æ•ˆæ€§"""
    print("\n" + "=" * 60)
    print("âš¡ å˜å¼‚æœ‰æ•ˆæ€§åˆ†æ")
    print("=" * 60)
    
    print("\nâœ… å½“å‰é€»è¾‘çš„ä¼˜ç‚¹:")
    print("1. ğŸ¯ é¿å…é€»è¾‘å†²çª")
    print("   - ä¸å†åŒæ—¶å˜å¼‚åˆå§‹é…ç½®å’Œæ¨¡å—è°ƒæ•´")
    print("   - è§£å†³äº†é‡å¤è®¡ç®—é—®é¢˜")
    
    print("2. ğŸ”§ ç²¾ç¡®å˜å¼‚æ§åˆ¶")
    print("   - æ¯æ¬¡åªå˜å¼‚ä¸€ä¸ªè½¦è¾†çš„åˆå§‹é…ç½®")
    print("   - æ¯æ¬¡åªå˜å¼‚ä¸€ä¸ªç«™ç‚¹çš„æ¨¡å—è°ƒæ•´")
    print("   - å‡å°‘äº†å˜å¼‚çš„ç ´åæ€§")
    
    print("3. ğŸš— è½¦å¤´æ—¶è·ç‹¬ç«‹å˜å¼‚")
    print("   - ä¸å½±å“æ¨¡å—é…ç½®")
    print("   - ä¿æŒæ—¶é—´çº¦æŸçš„ä¸€è‡´æ€§")
    
    print("\nâš ï¸ æ½œåœ¨é—®é¢˜:")
    print("1. ğŸŒ å˜å¼‚å¼ºåº¦å¯èƒ½ä¸è¶³")
    print("   - æ¯æ¬¡åªå˜å¼‚ä¸€ä¸ªå…ƒç´ ")
    print("   - å¯èƒ½å¯¼è‡´æ”¶æ•›è¿‡æ…¢")
    print("   - æ¢ç´¢èƒ½åŠ›æœ‰é™")
    
    print("2. ğŸ”„ ç¼ºå°‘é‡æ–°ç”Ÿæˆæœºåˆ¶")
    print("   - åˆå§‹é…ç½®å˜å¼‚åæ²¡æœ‰é‡æ–°ç”Ÿæˆ module_adjustments")
    print("   - adjustment_ranges å¯èƒ½è¿‡æ—¶")
    print("   - å½±å“åç»­æ¨¡å—è°ƒæ•´å˜å¼‚çš„å‡†ç¡®æ€§")
    
    print("3. ğŸ“Š ç¼ºå°‘è‡ªé€‚åº”æœºåˆ¶")
    print("   - å˜å¼‚æ¦‚ç‡å’Œå¼ºåº¦å›ºå®š")
    print("   - æ²¡æœ‰æ ¹æ®è¿›åŒ–é˜¶æ®µè°ƒæ•´")
    print("   - æ— æ³•é€‚åº”ä¸åŒé—®é¢˜ç‰¹å¾")

def suggest_improvements():
    """æå‡ºæ”¹è¿›å»ºè®®"""
    print("\n" + "=" * 60)
    print("ğŸš€ æ”¹è¿›å»ºè®®")
    print("=" * 60)
    
    print("\n1. ğŸ”„ æ·»åŠ é‡æ–°ç”Ÿæˆæœºåˆ¶")
    print("   ```python")
    print("   if need_recalculate_ranges:")
    print("       updated_individual = regenerate_module_adjustments_for_individual(")
    print("           individual, parameters, global_demand_data)")
    print("       # æ›´æ–° module_adjustments å’Œ adjustment_ranges")
    print("   ```")
    
    print("\n2. ğŸ“ˆ è‡ªé€‚åº”å˜å¼‚å¼ºåº¦")
    print("   ```python")
    print("   # æ ¹æ®è¿›åŒ–ä»£æ•°è°ƒæ•´å˜å¼‚å¼ºåº¦")
    print("   generation_ratio = current_gen / max_gen")
    print("   if generation_ratio < 0.3:")
    print("       mutation_strength *= 1.5  # æ—©æœŸå¢å¼ºæ¢ç´¢")
    print("   elif generation_ratio > 0.7:")
    print("       mutation_strength *= 0.7  # åæœŸç²¾ç»†è°ƒä¼˜")
    print("   ```")
    
    print("\n3. ğŸ¯ å¤šå…ƒç´ å˜å¼‚é€‰é¡¹")
    print("   ```python")
    print("   # æ ¹æ®æƒ…å†µé€‰æ‹©å˜å¼‚å¤šä¸ªå…ƒç´ ")
    print("   if random.random() < 0.3:  # 30%æ¦‚ç‡è¿›è¡Œå¤šå…ƒç´ å˜å¼‚")
    print("       num_mutations = random.randint(2, 3)")
    print("       # å˜å¼‚å¤šä¸ªè½¦è¾†æˆ–ç«™ç‚¹")
    print("   ```")
    
    print("\n4. ğŸ” å˜å¼‚æ•ˆæœç›‘æ§")
    print("   ```python")
    print("   # è®°å½•å˜å¼‚å‰åçš„é€‚åº”åº¦å˜åŒ–")
    print("   mutation_history = {")
    print("       'type': mutation_type,")
    print("       'fitness_before': old_fitness,")
    print("       'fitness_after': new_fitness")
    print("   }")
    print("   ```")

def create_mutation_flow_diagram():
    """åˆ›å»ºå˜å¼‚æµç¨‹å›¾"""
    print("\n" + "=" * 60)
    print("ğŸ“Š å˜å¼‚æµç¨‹å›¾")
    print("=" * 60)
    
    print("""
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    intelligent_mutate                      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              1. è½¦å¤´æ—¶è·å˜å¼‚                                â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚  â”‚ for each vehicle:                                   â”‚    â”‚
    â”‚  â”‚   if random() < mutpb:                             â”‚    â”‚
    â”‚  â”‚     new_headway = current + random(-3, 3)          â”‚    â”‚
    â”‚  â”‚     clamp to [min_headway, max_headway]            â”‚    â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              2. é€‰æ‹©å˜å¼‚ç±»å‹                                â”‚
    â”‚                random.randint(0, 1)                        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚     åˆå§‹é…ç½®å˜å¼‚          â”‚   â”‚      æ¨¡å—è°ƒæ•´å˜å¼‚             â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚ éšæœºé€‰æ‹©ä¸€ä¸ªè½¦è¾†    â”‚  â”‚   â”‚  â”‚ éšæœºé€‰æ‹©ä¸€ä¸ªè½¦è¾†+ç«™ç‚¹   â”‚  â”‚
    â”‚  â”‚ é‡æ–°ç”Ÿæˆæ¨¡å—é…ç½®    â”‚  â”‚   â”‚  â”‚ åŸºäºrangeså˜å¼‚deltaå€¼   â”‚  â”‚
    â”‚  â”‚ need_recalculate=T  â”‚  â”‚   â”‚  â”‚ ç›´æ¥ä¿®æ”¹adjustments     â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    3. è¿”å›ä¸ªä½“                               â”‚
    â”‚              âš ï¸ ç¼ºå°‘é‡æ–°ç”Ÿæˆé€»è¾‘                             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    """)

if __name__ == "__main__":
    analyze_current_mutation_logic()
    simulate_mutation_behavior()
    analyze_mutation_effectiveness()
    suggest_improvements()
    create_mutation_flow_diagram()
    
    print("\n" + "=" * 60)
    print("ğŸ“ æ€»ç»“")
    print("=" * 60)
    print("å½“å‰å˜å¼‚é€»è¾‘å·²ç»è§£å†³äº†ä¹‹å‰çš„é€»è¾‘å†²çªé—®é¢˜ï¼Œ")
    print("ä½†ä»éœ€è¦æ·»åŠ é‡æ–°ç”Ÿæˆæœºåˆ¶å’Œè‡ªé€‚åº”ç­–ç•¥æ¥æé«˜æ•ˆæœã€‚")
    print("å»ºè®®ä¼˜å…ˆå®ç°é‡æ–°ç”Ÿæˆæœºåˆ¶ï¼Œç¡®ä¿å˜å¼‚çš„ä¸€è‡´æ€§ã€‚")
